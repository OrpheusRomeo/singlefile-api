version: '3.8'

# 定义服务
services:
  singlefile-api:
    image: singlefile-api:latest
    container_name: singlefile-service
    restart: always
    ports:
      - "3009:3000"
    volumes:
      - ./data/singlefile-downloads:/downloads  
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      - NODE_ENV=production  # 生产环境
      - PORT=3000            # 服务端口（与容器内暴露的端口一致）
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
    cap_add:
      - SYS_ADMIN
    deploy:
      resources:
        limits:
          cpus: '1'          # 最多使用 1 个 CPU 核心
          memory: 1G         # 最多使用 1GB 内存
        reservations:
          cpus: '0.5'        # 预留 0.5 个 CPU 核心
          memory: 512M       # 预留 512MB 内存
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s          # 每 30 秒检查一次
      timeout: 10s           # 检查超时时间 10 秒
      retries: 3             # 失败 3 次判定为不健康
      start_period: 60s      # 容器启动后 60 秒再开始检查

# 定义卷（可选，与上面的 volumes 对应，确保数据持久化）
volumes:
  singlefile-downloads:
    driver: local
